# Database Migrations with Alembic

This directory contains Alembic database migrations for the AniBridge project. Alembic manages the database schema evolution in a version-controlled, reproducible way.

## Directory Structure

```
alembic/
├── versions/          # Migration scripts (autogenerated and manual)
├── env.py            # Alembic environment configuration
├── script.py.mako    # Template for new migration files
└── README.md         # This file

alembic.ini           # Alembic configuration file (in project root)
```

## Key Concepts

- **Migrations**: Version-controlled database schema changes
- **Autogenerate**: Alembic can automatically detect model changes and generate migrations
- **Upgrade/Downgrade**: Each migration can be applied (`upgrade`) or rolled back (`downgrade`)
- **Revision History**: Linear chain of migrations from initial schema to current state

## Common Operations

### 1. Creating a New Migration

After modifying models in `app/db/models.py`:

```bash
# Auto-generate migration based on model changes
alembic revision --autogenerate -m "Add user preferences table"

# Review the generated file in alembic/versions/
# Edit if necessary to add data migrations or custom logic
```

### 2. Applying Migrations

```bash
# Apply all pending migrations
alembic upgrade head

# Apply migrations to a specific revision
alembic upgrade <revision_id>

# Apply one migration at a time
alembic upgrade +1
```

### 3. Rolling Back Migrations

```bash
# Rollback one migration
alembic downgrade -1

# Rollback to a specific revision
alembic downgrade <revision_id>

# Rollback all migrations
alembic downgrade base
```

### 4. Checking Migration Status

```bash
# Show current revision
alembic current

# Show migration history
alembic history

# Show pending migrations
alembic heads
```

### 5. Manual Migration Creation

For complex migrations that can't be autogenerated:

```bash
alembic revision -m "Complex data transformation"

# Edit the generated file to add custom upgrade/downgrade logic
```

## Automatic Migration on Startup

The application automatically runs pending migrations on startup via `app.db.migrations.run_migrations()`. This is called in the FastAPI lifespan context (`app/core/lifespan.py`).

This ensures:
- Database schema is always up-to-date
- No manual migration steps required for deployment
- Development environment stays in sync

## Adding New Models

When adding a new SQLModel table:

1. **Define the model** in `app/db/models.py`:
   ```python
   from app.db.base import ModelBase
   from sqlmodel import Field
   
   class MyNewModel(ModelBase, table=True):
       id: int = Field(primary_key=True)
       name: str
       description: Optional[str] = None
   ```

2. **Generate migration**:
   ```bash
   alembic revision --autogenerate -m "Add MyNewModel table"
   ```

3. **Review the migration** in `alembic/versions/`:
   - Check that columns, indexes, and constraints are correct
   - Add any custom data migrations or initialization

4. **Apply the migration**:
   ```bash
   alembic upgrade head
   ```

5. **Test** both upgrade and downgrade:
   ```bash
   alembic downgrade -1  # Test rollback
   alembic upgrade head  # Re-apply
   ```

## Migration File Structure

Each migration file contains:

```python
"""Description of changes

Revision ID: abc123
Revises: xyz789
Create Date: 2025-10-22 00:00:00
"""

def upgrade() -> None:
    """Apply forward migration."""
    # Auto-generated or manual SQL operations
    op.create_table('mytable', ...)
    
def downgrade() -> None:
    """Rollback migration."""
    # Reverse operations
    op.drop_table('mytable')
```

## Best Practices

1. **Always review autogenerated migrations** - They might not capture all intent
2. **Include data migrations when needed** - Schema changes may require data transformation
3. **Test rollbacks** - Ensure downgrade works before committing
4. **Keep migrations small and focused** - One logical change per migration
5. **Don't modify existing migrations** - Create new ones to fix issues
6. **Document complex migrations** - Add comments explaining non-obvious logic

## Troubleshooting

### Migration conflicts
If multiple developers create migrations simultaneously:
```bash
# Merge migrations manually or use:
alembic merge <rev1> <rev2> -m "Merge migrations"
```

### Reset database (DESTRUCTIVE)
To start fresh (development only):
```bash
rm data/anibridge_jobs.db
alembic upgrade head
```

### Check schema without applying
```bash
alembic upgrade head --sql  # Output SQL without executing
```

### Environment issues
Ensure `DATA_DIR` environment variable is set correctly, as it determines the database location.

## Integration with SQLModel

The migration system is tightly integrated with SQLModel:

- **Metadata**: `ModelBase.metadata` (from `app.db.base`) is used as `target_metadata` in `env.py`
- **Models**: All models inherit from `ModelBase` to register with metadata
- **Database URL**: Imported from `app.db.session.DATABASE_URL` to ensure consistency

## Continuous Integration

In CI/CD pipelines:

1. **Check for pending migrations**:
   ```bash
   alembic check  # Fails if models and migrations are out of sync
   ```

2. **Test migrations**:
   ```bash
   alembic upgrade head
   alembic downgrade base
   alembic upgrade head
   ```

3. **Auto-apply in deployment**:
   - Application startup automatically runs migrations
   - No manual intervention needed

## Further Reading

- [Alembic Documentation](https://alembic.sqlalchemy.org/)
- [SQLModel Documentation](https://sqlmodel.tiangolo.com/)
- [SQLAlchemy Migrations](https://docs.sqlalchemy.org/en/14/core/metadata.html)
